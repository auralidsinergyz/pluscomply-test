var SimpleModal=new Class({Implements:[Options],request:null,buttons:[],lightbox:{},options:{onAppend:Function,offsetTop:40,overlayOpacity:.3,overlayColor:"#000000",width:400,draggable:!0,keyEsc:!0,overlayClick:!0,alwaysImage:!0,closeButton:!0,hideHeader:!1,hideFooter:!1,lightboxExcessWidth:40,lightboxExcessHeight:120,btn_ok:"OK",btn_cancel:"Cancel",template:'<div class="simple-modal-header">             <h1>{_TITLE_}</h1>           </div>           <div class="simple-modal-body">             <div class="contents">{_CONTENTS_}</div>           </div>           <div class="simple-modal-footer"></div>'},initialize:function(a){this.setOptions(a)},show:function(a){switch(a||(a={}),a.draw=void 0==a.draw||a.draw,a.draw&&this._overlay("show"),a.model){case"confirm":this.addButton(this.options.btn_ok,"btn primary btn-margin",function(){try{a.callback()}catch(a){}this.hide()}),this.addButton(this.options.btn_cancel,"btn secondary");var b=this._drawWindow(a);this._addEscBehaviour();break;case"modal":var b=this._drawWindow(a);this._addEscBehaviour();break;case"modal-ajax":var b=this._drawWindow(a);this._loadContents({url:a.param.url||"",onRequestComplete:a.param.onRequestComplete||Function});break;case"lightbox":a.arrows=!0,this.lightbox.element=a.lightbox.element,this.lightbox.group=a.lightbox.group,this.lightbox.order=a.lightbox.order;var b=this._drawWindow(a);this._loadContents({url:a.param.url||"",order:this.lightbox.order,draw:a.draw,onRequestComplete:a.param.onRequestComplete||Function});break;default:this.addButton(this.options.btn_ok,"btn primary");var b=this._drawWindow(a);this._addEscBehaviour()}if(b.setStyles({width:this.options.width}),this.options.hideHeader&&b.addClass("hide-header"),this.options.hideFooter&&b.addClass("hide-footer"),this.options.closeButton&&this._addCloseButton(),this.options.draggable){var c=b.getElement(".simple-modal-header");new Drag(b,{handle:c}),c.setStyle("cursor","move"),b.addClass("draggable")}this._display()},hide:function(){try{"object"==typeof this.request&&this.request.cancel()}catch(a){}this._overlay("hide")},_drawWindow:function(a){var b;a.draw?(b=new Element("div#simple-modal",{class:"simple-modal"}),b.inject($$("body")[0])):b=document.getElement("#simple-modal.simple-modal");var c=this._template(this.options.template,{_TITLE_:a.title||"Untitled",_CONTENTS_:a.contents||""});return b.set("html",c),this._injectAllButtons(),a.arrows&&this._addArrows(),this.options.onAppend(),b},addButton:function(a,b,c){var d=new Element("a",{title:a,text:a,class:b,events:{click:(c||this.hide).bind(this)}});return this.buttons.push(d),d},_injectAllButtons:function(){this.buttons.each(function(a,b){a.inject($("simple-modal").getElement(".simple-modal-footer"))})},_addCloseButton:function(){var a=new Element("a",{class:"close",href:"#",html:"x"});return a.inject($("simple-modal"),"top"),a.addEvent("click",function(a){a&&a.stop(),this.hide()}.bind(this)),a},_addArrows:function(){var a=new Element("a",{class:"next-image",style:"display:none",href:"#",html:"&raquo;"});a.inject($("simple-modal"),"top"),a.addEvent("click",function(a){a&&a.stop(),this._viewNextElement()}.bind(this));var b=new Element("a",{class:"previous-image",style:"display:none",href:"#",html:"&laquo;"});b.inject($("simple-modal"),"top"),b.addEvent("click",function(a){a&&a.stop(),this._viewPreviousElement()}.bind(this)),this._setArrowsVisibility()},_viewNextElement:function(){var a=this._getElementsByGroup(this.lightbox.group);this.lightbox.order++;var b=a[this.lightbox.order];this.show({model:"lightbox",title:b.get("title"),draw:!1,param:{url:b.get("href"),onRequestComplete:function(){}},lightbox:{element:b,group:this.lightbox.group,order:this.lightbox.order}})},_viewPreviousElement:function(){var a=this._getElementsByGroup(this.lightbox.group);this.lightbox.order--;var b=a[this.lightbox.order];this.show({model:"lightbox",title:b.get("title"),draw:!1,param:{url:b.get("href"),onRequestComplete:function(){}},lightbox:{element:b,group:this.lightbox.group,order:this.lightbox.order}})},_setArrowsVisibility:function(){var a=document.getElement(".simple-modal a.previous-image"),b=document.getElement(".simple-modal a.next-image"),c=this.getTotalByGroup(this.lightbox.group);0==this.lightbox.order?a.setStyle("display","none"):a.setStyle("display","inline"),c>0&&this.lightbox.order<c-1?b.setStyle("display","inline"):b.setStyle("display","none")},_getElementsByGroup:function(a){var b=$$("a").filter(function(b){return b.rel&&b.rel.contains("simplemodal["+a+"]")});return b},getTotalByGroup:function(a){return this._getElementsByGroup(a).length},_overlay:function(a){switch(a){case"show":this._overlay("hide");var b=new Element("div",{id:"simple-modal-overlay"});b.inject($$("body")[0]),b.setStyle("background-color",this.options.overlayColor),b.fade("hide").fade(this.options.overlayOpacity),this.options.overlayClick&&b.addEvent("click",function(a){a&&a.stop(),this.hide()}.bind(this)),this.__resize=this._display.bind(this),window.addEvent("resize",this.__resize);break;case"hide":if(window.removeEvent("resize",this._display),this.options.keyEsc){var c="ie"!=Browser.name?"keydown":"onkeydown";window.removeEvent(c,this._removeSM)}try{$("simple-modal-overlay").destroy()}catch(a){}try{$("simple-modal").destroy()}catch(a){}}},_loadContents:function(param){$("simple-modal").addClass("loading");var re=new RegExp(/([^\/\\]+)\.(jpg|png|gif)$/i);if(param.url.match(re)||this.options.alwaysImage){$("simple-modal").addClass("hide-footer"),$("simple-modal-overlay").removeEvents();var images=[param.url];new Asset.images(images,{onProgress:function(a){immagine=this},onComplete:function(){try{$("simple-modal").removeClass("loading");var a=$("simple-modal").getElement(".simple-modal-body"),b=a.getStyle("padding").split(" "),c=immagine.get("width").toInt(),d=immagine.get("height").toInt(),e=this._scaleImage(c,d);c=e.width,d=e.height;new Fx.Tween($("simple-modal"),{duration:"normal",transition:"sine:out",link:"cancel",property:"width"}).start($("simple-modal").getCoordinates().width,c+b[1].toInt()+b[3].toInt()+$("simple-modal").getStyle("border-left-width").toInt()+$("simple-modal").getStyle("border-right-width").toInt()),new Fx.Tween(a,{duration:"normal",transition:"sine:out",link:"cancel",property:"height"}).start(a.getCoordinates().height,d).chain(function(){immagine.inject($("simple-modal").getElement(".contents").empty()).fade("hide").setStyles({width:c,height:d}).fade("in"),this._display(),this._addEscBehaviour()}.bind(this)),new Fx.Tween($("simple-modal"),{duration:"normal",transition:"sine:out",link:"cancel",property:"left"}).start($("simple-modal").getCoordinates().left,(window.getCoordinates().width-c)/2)}catch(a){}}.bind(this)})}else this.request=new Request.HTML({evalScripts:!1,url:param.url,method:"get",onRequest:function(){},onSuccess:function(responseTree,responseElements,responseHTML,responseJavaScript){$("simple-modal").removeClass("loading"),$("simple-modal").getElement(".contents").set("html",responseHTML),param.onRequestComplete(),eval(responseJavaScript),this._display(),this._addEscBehaviour()}.bind(this),onFailure:function(){$("simple-modal").removeClass("loading"),$("simple-modal").getElement(".contents").set("html","loading failed")}}).send()},_scaleImage:function(a,b){var c=this.options.lightboxExcessHeight+this.options.offsetTop,d=this.options.lightboxExcessWidth,e=a,f=b,g=window.getSize().x-d,h=window.getSize().y-c;return ratio=e<=f?f/h:e/g,ratio=Math.max(ratio,1),a=parseInt(e/ratio),b=parseInt(f/ratio),{width:a,height:b}},_display:function(){try{$("simple-modal-overlay").setStyles({height:window.getCoordinates().height})}catch(a){}try{var a=this.options.offsetTop||0;$("simple-modal").setStyles({top:a,left:(window.getCoordinates().width-$("simple-modal").getCoordinates().width)/2})}catch(a){}},_addEscBehaviour:function(){if(this.options.keyEsc&&(this._removeSM=function(a){"esc"==a.key&&this.hide()}.bind(this),this.options.keyEsc)){var a="ie"!=Browser.name?"keydown":"onkeydown";window.addEvent(a,this._removeSM)}},_template:function(a,b){for(var c in b)a=a.replace(new RegExp("{"+c+"}","g"),b[c]);return a}});SimpleModal.autoload=function(){var a=$$("a").filter(function(a){return a.rel&&a.rel.test(/^simplemodal/i)}),b=[],c=new SimpleModal;$$(a).each(function(a){var d=a.rel.replace(/[[]|]/gi," "),e=d.split(" ");b[e[1]]=null==b[e[1]]?0:b[e[1]]+1;var f=b[e[1]];a.addEvent("click",function(a){a.stop(),c.show({model:"lightbox",title:this.get("title"),param:{url:this.get("href"),onRequestComplete:function(){}},lightbox:{element:this,group:e[1],order:f}})})})},window.addEvent("domready",SimpleModal.autoload);